<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
        }
        .timer-ring {
            transform: rotate(-90deg);
            transform-origin: center;
        }
        .rest-timer-active {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-4xl mx-auto pb-20"></div>

    <script>
        // Storage wrapper with localStorage fallback
        const storage = {
            get: async (key) => {
                try {
                    const result = await window.storage.get(key);
                    return result ? JSON.parse(result.value) : null;
                } catch (error) {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                }
            },
            set: async (key, value) => {
                try {
                    await window.storage.set(key, JSON.stringify(value));
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                }
            }
        };

        // State management
        let state = {
            currentView: 'workout',
            workouts: [],
            activeTimer: null,
            currentWorkout: null,
            workoutProgram: null
        };

        // Initialize
        async function init() {
            await loadData();
            render();
        }

        async function loadData() {
            const workoutsData = await storage.get('workouts');
            
            state.workouts = workoutsData || [];
            
            // Charles's program
            state.workoutProgram = {
                name: "Upper/Lower 4-Day + Zone 5",
                duration: 6,
                split: [
                    "Upper 1 - Horizontal Push/Pull",
                    "Lower 1 - Quad/Hip Dominant",
                    "Upper 2 - Vertical Push/Pull",
                    "Lower 2 - Posterior/Unilateral",
                    "Bonus! Zone 5 Cardio"
                ],
                startDate: new Date().toISOString(),
                programDetails: {
                    "Upper 1 - Horizontal Push/Pull": {
                        exercises: [
                            { name: "DB Bench Press", sets: "4x8-10", rest: "90-120 sec", notes: "Control down, explosive up" },
                            { name: "DB Bent Over Row", sets: "4x10-12", rest: "90 sec", notes: "Pull to hip, squeeze at top" },
                            { name: "Superset A1: Incline DB Press", sets: "3x10-12", rest: "60 sec", notes: "45-degree angle" },
                            { name: "Superset A2: Chest Supported DB Row", sets: "3x10-12", rest: "60 sec", notes: "Or regular DB row" },
                            { name: "Superset B1: Cable Lateral Raise", sets: "2x12-15", rest: "45 sec", notes: "Alt: DB lateral raise + band face pulls at rig" },
                            { name: "Superset B2: Cable Face Pulls", sets: "2x15-20", rest: "45 sec", notes: "Pull to face, squeeze rear delts" },
                            { name: "Finisher C1: Dips", sets: "2x8-12", rest: "30 sec", notes: "Assisted if needed" },
                            { name: "Finisher C2: Push-ups", sets: "2x max", rest: "30 sec", notes: "To failure" },
                            { name: "Finisher C3: DB Curls", sets: "2x failure", rest: "30 sec", notes: "Burn it out" }
                        ]
                    },
                    "Lower 1 - Quad/Hip Dominant": {
                        exercises: [
                            { name: "Goblet Squat", sets: "4x10-12", rest: "90 sec", notes: "Chest up, squat deep" },
                            { name: "DB Bulgarian Split Squat", sets: "3x8-10/leg", rest: "90 sec", notes: "Back foot elevated, front shin vertical" },
                            { name: "Superset A1: Leg Press", sets: "3x12-15", rest: "60 sec", notes: "Feet LOWER on platform (quad focus)" },
                            { name: "Superset A2: Calf Raise on Leg Press", sets: "3x15-20", rest: "60 sec", notes: "To near failure, stay on leg press machine" },
                            { name: "Leg Extension", sets: "2x12-15", rest: "60 sec", notes: "Burn it out" },
                            { name: "Lying Leg Curl", sets: "2x12-15", rest: "60 sec", notes: "Burn it out" }
                        ]
                    },
                    "Upper 2 - Vertical Push/Pull": {
                        exercises: [
                            { name: "DB Seated Shoulder Press", sets: "4x8-10", rest: "90-120 sec", notes: "Strict form, full ROM" },
                            { name: "Lat Pulldown", sets: "4x10-12", rest: "90 sec", notes: "Pull to chest, squeeze lats" },
                            { name: "Superset A1: DB Arnold Press", sets: "3x10-12", rest: "60 sec", notes: "Rotate palms as you press" },
                            { name: "Superset A2: DB Shrugs", sets: "3x12-15", rest: "60 sec", notes: "Squeeze traps at top" },
                            { name: "Superset B1: Cable Rope Tricep Pushdown", sets: "2x12-15", rest: "45 sec", notes: "Full extension" },
                            { name: "Superset B2: Cable Bicep Curl", sets: "2x12-15", rest: "45 sec", notes: "Keep elbows still" },
                            { name: "Superset C1: DB Front Raise", sets: "2x12-15", rest: "45 sec", notes: "To shoulder height" },
                            { name: "Superset C2: Cable Reverse Fly", sets: "2x15", rest: "45 sec", notes: "Crossed cables high, pull back squeezing rear delts" }
                        ]
                    },
                    "Lower 2 - Posterior/Unilateral": {
                        exercises: [
                            { name: "Smith Machine RDL", sets: "4x10-12", rest: "90 sec", notes: "START LIGHT - hinge at hips, bar close to legs, stop mid-shin" },
                            { name: "DB Reverse Lunges", sets: "3x10/leg", rest: "90 sec", notes: "Step back, drop knee, push through front heel" },
                            { name: "Hamstring Curl Machine", sets: "3x12-15", rest: "60 sec", notes: "Control the negative" },
                            { name: "Superset A1: Leg Press", sets: "2x15", rest: "60 sec", notes: "Feet HIGH on platform (glute/posterior focus)" },
                            { name: "Superset A2: Calf Raise on Leg Press", sets: "2x20", rest: "60 sec", notes: "Stay on leg press machine" },
                            { name: "Finisher B1: Glute Bridge", sets: "2x20", rest: "30 sec", notes: "Squeeze glutes at top" },
                            { name: "Finisher B2: Plank", sets: "2x45 sec", rest: "30 sec", notes: "Keep core tight" }
                        ]
                    },
                    "Bonus! Zone 5 Cardio": {
                        exercises: [],
                        cardioOptions: [
                            "üö£ Rower: 8 rounds √ó (20 sec sprint, 40 sec easy)",
                            "üö¥ Fan Bike: 6 rounds √ó (30 sec all-out, 90 sec recovery)",
                            "üèÉ Field Sprints: 6-8 √ó 100m sprints (walk back recovery)",
                            "‚õ∞Ô∏è Stairmaster: 10 min - 30 sec fast, 30 sec moderate",
                            "üèÉ Track Intervals: 4-6 √ó 400m @ hard effort (2 min rest)",
                            "üö¥ Bike Sprints: 10 rounds √ó (15 sec max, 45 sec easy)"
                        ]
                    }
                }
            };
        }

        async function saveWorkouts() {
            await storage.set('workouts', state.workouts);
        }

        function getCurrentWeek() {
            if (!state.workoutProgram || !state.workoutProgram.startDate) return 1;
            
            const start = new Date(state.workoutProgram.startDate);
            const now = new Date();
            
            const startMonday = new Date(start);
            startMonday.setDate(start.getDate() - start.getDay() + 1);
            startMonday.setHours(0, 0, 0, 0);
            
            const currentMonday = new Date(now);
            currentMonday.setDate(now.getDate() - now.getDay() + 1);
            currentMonday.setHours(0, 0, 0, 0);
            
            const diffTime = currentMonday - startMonday;
            const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
            
            const weekInCycle = (diffWeeks % state.workoutProgram.duration) + 1;
            
            return weekInCycle;
        }

        function getWeekDates() {
            const now = new Date();
            const week = [];
            const day = now.getDay();
            
            const monday = new Date(now);
            monday.setDate(now.getDate() - day + 1);
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                week.push(date.toDateString());
            }
            return week;
        }

        // Render functions
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${renderHeader()}
                ${renderNavigation()}
                ${renderContent()}
            `;
        }

        function renderHeader() {
            return `
                <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6 shadow-lg">
                    <h1 class="text-3xl font-bold">Workout Tracker</h1>
                    <p class="text-emerald-100 mt-1">Track your progress</p>
                </div>
            `;
        }

        function renderNavigation() {
            const tabs = [
                { id: 'workout', label: 'Workouts', icon: 'üí™' },
                { id: 'dashboard', label: 'Stats', icon: 'üìä' }
            ];

            return `
                <div class="bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="flex">
                        ${tabs.map(tab => `
                            <button 
                                onclick="switchView('${tab.id}')"
                                class="flex-1 py-4 px-4 text-center font-medium transition-colors ${
                                    state.currentView === tab.id 
                                        ? 'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50' 
                                        : 'text-gray-600 hover:bg-gray-50'
                                }">
                                <span class="text-xl">${tab.icon}</span>
                                <div class="text-sm mt-1">${tab.label}</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderContent() {
            switch(state.currentView) {
                case 'workout':
                    return renderWorkoutView();
                case 'dashboard':
                    return renderDashboardView();
                default:
                    return '';
            }
        }

        function renderWorkoutView() {
            if (state.currentWorkout) {
                return renderActiveWorkout();
            }

            const currentWeek = getCurrentWeek();
            const thisWeekDates = getWeekDates();
            
            const completedThisWeek = {};
            state.workouts.forEach(workout => {
                const workoutDate = new Date(workout.date).toDateString();
                if (thisWeekDates.includes(workoutDate)) {
                    completedThisWeek[workout.day] = true;
                }
            });

            return `
                <div class="p-4">
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-2">${state.workoutProgram.name}</h2>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-emerald-100">Week ${currentWeek} of ${state.workoutProgram.duration}</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span>Program Progress</span>
                                <span>${Math.round((currentWeek / state.workoutProgram.duration) * 100)}%</span>
                            </div>
                            <div class="bg-white/20 rounded-full h-2">
                                <div class="bg-white h-2 rounded-full transition-all" 
                                    style="width: ${(currentWeek / state.workoutProgram.duration) * 100}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">This Week's Workouts</h3>
                        <div class="grid grid-cols-1 gap-3">
                            ${state.workoutProgram.split.map((day, index) => {
                                const isCompleted = completedThisWeek[day];
                                const isZone5 = day.includes('Zone 5');
                                
                                return `
                                    <div class="bg-white rounded-lg shadow p-4 border-2 ${isCompleted ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200'}">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <h4 class="font-bold text-gray-900">${day.split(' - ')[0]}</h4>
                                                    ${isCompleted ? '<span class="text-emerald-600">‚úì</span>' : ''}
                                                </div>
                                                ${!isZone5 ? `<p class="text-sm text-gray-600">${day.split(' - ')[1] || ''}</p>` : 
                                                    '<p class="text-sm text-gray-600">Quick cardio blast</p>'}
                                            </div>
                                            <button 
                                                onclick="startSpecificWorkout('${day}')"
                                                class="px-4 py-2 rounded-lg font-medium ${
                                                    isCompleted 
                                                        ? 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200' 
                                                        : 'bg-emerald-600 text-white hover:bg-emerald-700'
                                                }">
                                                ${isCompleted ? 'Redo' : 'Start'}
                                            </button>
                                        </div>
                                        ${!isZone5 && state.workoutProgram.programDetails?.[day] ? `
                                            <div class="text-xs text-gray-500 mt-2">
                                                ${state.workoutProgram.programDetails[day].exercises.length} exercises
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 mb-4">
                        <button onclick="showWorkoutHistory()" class="bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-200">
                            üìÖ View History
                        </button>
                    </div>

                    ${renderRecentWorkouts()}
                </div>
            `;
        }

        function startSpecificWorkout(day) {
            const programTemplate = state.workoutProgram?.programDetails?.[day];
            
            // Zone 5 cardio - simple completion tracking
            if (day.includes('Zone 5')) {
                state.currentWorkout = {
                    day,
                    date: new Date().toISOString(),
                    exercises: [],
                    week: getCurrentWeek(),
                    isZone5: true
                };
                render();
                return;
            }
            
            const exercises = [];

            if (programTemplate?.exercises) {
                programTemplate.exercises.forEach(templateEx => {
                    const setsMatch = templateEx.sets.match(/^(\d+)/);
                    const numSets = setsMatch ? parseInt(setsMatch[1]) : 3;
                    
                    const lastPerformance = getLastPerformanceData(templateEx.name, day);
                    
                    const sets = [];
                    for (let i = 0; i < numSets; i++) {
                        if (lastPerformance && lastPerformance[i]) {
                            sets.push({
                                weight: lastPerformance[i].weight || '',
                                reps: lastPerformance[i].reps || ''
                            });
                        } else {
                            sets.push({ weight: '', reps: '' });
                        }
                    }
                    
                    exercises.push({
                        name: templateEx.name,
                        sets: sets,
                        templateNotes: templateEx.notes || ''
                    });
                });
            }

            state.currentWorkout = {
                day,
                date: new Date().toISOString(),
                exercises: exercises,
                week: getCurrentWeek()
            };

            render();
        }

        function getLastPerformanceData(exerciseName, workoutDay) {
            const pastWorkouts = state.workouts
                .filter(w => w.day === workoutDay)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let workout of pastWorkouts) {
                const exercise = workout.exercises.find(ex => ex.name === exerciseName);
                if (exercise && exercise.sets && exercise.sets.length > 0) {
                    return exercise.sets.filter(s => s.weight || s.reps);
                }
            }
            return null;
        }

        function renderActiveWorkout() {
            const { day, exercises, isZone5 } = state.currentWorkout;
            
            if (isZone5) {
                return renderZone5Workout();
            }
            
            return `
                <div class="p-4">
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg shadow-lg p-6 mb-4">
                        <h2 class="text-2xl font-bold">${day}</h2>
                        <p class="text-emerald-100 mt-1">Week ${state.currentWorkout.week} ‚Ä¢ ${new Date().toLocaleDateString()}</p>
                    </div>

                    ${state.activeTimer ? renderRestTimer() : ''}

                    <div class="space-y-4 mb-4">
                        ${exercises.map((ex, i) => renderExercise(ex, i)).join('')}
                    </div>

                    <button onclick="addExercise()" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-emerald-700 mb-3">
                        + Add Exercise
                    </button>

                    <button onclick="finishWorkout()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700">
                        Finish Workout
                    </button>

                    <button onclick="cancelWorkout()" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 mt-2">
                        Cancel
                    </button>
                </div>
            `;
        }

        function renderZone5Workout() {
            const cardioOptions = state.workoutProgram.programDetails["Bonus! Zone 5 Cardio"].cardioOptions;
            
            return `
                <div class="p-4">
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg shadow-lg p-6 mb-4">
                        <h2 class="text-2xl font-bold">üî• Zone 5 Cardio</h2>
                        <p class="text-red-100 mt-1">Pick one option and go hard!</p>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 mb-4">
                        <h3 class="font-bold text-lg mb-4">Choose Your Workout:</h3>
                        <div class="space-y-3">
                            ${cardioOptions.map(option => `
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <p class="font-medium">${option}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong>Zone 5 = High Intensity</strong><br>
                            You should be breathing hard and unable to hold a conversation during the work intervals. 
                            Push yourself, but maintain good form!
                        </p>
                    </div>

                    <button onclick="finishZone5Workout()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700">
                        Complete Workout
                    </button>

                    <button onclick="cancelWorkout()" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 mt-2">
                        Cancel
                    </button>
                </div>
            `;
        }

        function finishZone5Workout() {
            state.workouts.push({
                day: state.currentWorkout.day,
                date: state.currentWorkout.date,
                week: state.currentWorkout.week,
                exercises: [],
                isZone5: true
            });
            
            saveWorkouts();
            state.currentWorkout = null;
            render();
        }

        function renderRestTimer() {
            const { remaining, total } = state.activeTimer;
            const progress = ((total - remaining) / total) * 283;
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4 rest-timer-active">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Rest Timer</h3>
                        <button onclick="stopTimer()" class="text-red-600 hover:bg-red-50 px-3 py-1 rounded">
                            Stop
                        </button>
                    </div>
                    <div class="flex items-center justify-center">
                        <svg width="120" height="120" class="transform -rotate-90">
                            <circle cx="60" cy="60" r="45" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle cx="60" cy="60" r="45" stroke="#10b981" stroke-width="8" fill="none"
                                stroke-dasharray="283" stroke-dashoffset="${283 - progress}"
                                class="transition-all duration-1000"/>
                        </svg>
                        <div class="absolute text-3xl font-bold">
                            ${minutes}:${seconds.toString().padStart(2, '0')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExercise(exercise, index) {
            const lastWeekPerformance = findLastWeekPerformance(exercise.name, state.currentWorkout.day);
            
            return `
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold">${exercise.name}</h3>
                        <button onclick="removeExercise(${index})" class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-sm">
                            Remove
                        </button>
                    </div>
                    
                    ${exercise.templateNotes ? `
                        <div class="text-xs text-blue-600 italic mb-2 bg-blue-50 p-2 rounded">
                            üí° ${exercise.templateNotes}
                        </div>
                    ` : ''}

                    ${lastWeekPerformance ? `
                        <div class="text-xs bg-gray-100 p-2 rounded mb-2">
                            <span class="font-medium text-gray-700">Last time:</span>
                            <span class="text-gray-600">${lastWeekPerformance}</span>
                        </div>
                    ` : ''}
                    
                    <div class="space-y-2 mb-3">
                        ${exercise.sets.map((set, setIndex) => `
                            <div class="flex items-center gap-2 bg-gray-50 p-2 rounded">
                                <span class="text-sm font-medium w-12">Set ${setIndex + 1}</span>
                                <input type="number" value="${set.weight || ''}" 
                                    onchange="updateSet(${index}, ${setIndex}, 'weight', this.value)"
                                    placeholder="lbs" class="w-20 border rounded px-2 py-1 text-sm">
                                <span class="text-xs text-gray-500">lbs √ó</span>
                                <input type="number" value="${set.reps || ''}"
                                    onchange="updateSet(${index}, ${setIndex}, 'reps', this.value)"
                                    placeholder="reps" class="w-16 border rounded px-2 py-1 text-sm">
                                <span class="text-xs text-gray-500">reps</span>
                                <button onclick="startRestTimer()" 
                                    class="ml-auto bg-emerald-100 text-emerald-600 px-3 py-1 rounded text-sm font-medium hover:bg-emerald-200">
                                    Rest
                                </button>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="addSet(${index})" class="text-emerald-600 text-sm font-medium mb-3">
                        + Add Set
                    </button>

                    <div class="mt-3 pt-3 border-t">
                        <label class="text-xs text-gray-600 font-medium">Notes:</label>
                        <textarea 
                            onchange="updateExerciseNotes(${index}, this.value)"
                            placeholder="Form cues, substitutions, how it felt..."
                            class="w-full border rounded px-2 py-1 text-sm mt-1 resize-none"
                            rows="2">${exercise.notes || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function findLastWeekPerformance(exerciseName, workoutDay) {
            const pastWorkouts = state.workouts
                .filter(w => w.day === workoutDay)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let workout of pastWorkouts) {
                const exercise = workout.exercises.find(ex => ex.name === exerciseName);
                if (exercise && exercise.sets && exercise.sets.length > 0) {
                    const setsDisplay = exercise.sets
                        .filter(s => s.weight && s.reps)
                        .map(s => `${s.weight} lbs √ó ${s.reps}`)
                        .join(', ');
                    
                    if (setsDisplay) {
                        return setsDisplay;
                    }
                }
            }
            return null;
        }

        function updateExerciseNotes(index, notes) {
            state.currentWorkout.exercises[index].notes = notes;
        }

        function addExercise() {
            const name = prompt('Exercise name:');
            if (!name) return;

            state.currentWorkout.exercises.push({
                name,
                sets: [{ weight: '', reps: '' }],
                notes: ''
            });
            render();
        }

        function removeExercise(index) {
            if (confirm('Remove this exercise?')) {
                state.currentWorkout.exercises.splice(index, 1);
                render();
            }
        }

        function addSet(exerciseIndex) {
            state.currentWorkout.exercises[exerciseIndex].sets.push({ weight: '', reps: '' });
            render();
        }

        function updateSet(exerciseIndex, setIndex, field, value) {
            state.currentWorkout.exercises[exerciseIndex].sets[setIndex][field] = value;
        }

        function startRestTimer() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full p-6">
                    <h3 class="text-xl font-bold mb-4">Rest Timer</h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="startTimerWithDuration(60); closeOverlay();" 
                            class="bg-emerald-500 text-white py-4 rounded-lg text-lg font-bold hover:bg-emerald-600">
                            60s
                        </button>
                        <button onclick="startTimerWithDuration(90); closeOverlay();" 
                            class="bg-emerald-500 text-white py-4 rounded-lg text-lg font-bold hover:bg-emerald-600">
                            90s
                        </button>
                        <button onclick="startTimerWithDuration(120); closeOverlay();" 
                            class="bg-emerald-500 text-white py-4 rounded-lg text-lg font-bold hover:bg-emerald-600">
                            2m
                        </button>
                        <button onclick="startTimerWithDuration(180); closeOverlay();" 
                            class="bg-emerald-500 text-white py-4 rounded-lg text-lg font-bold hover:bg-emerald-600">
                            3m
                        </button>
                    </div>
                    
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium mb-2">Custom (seconds):</label>
                        <input type="number" id="custom-timer" placeholder="e.g., 45" 
                            class="w-full border rounded-lg px-3 py-2 mb-3">
                        <button onclick="startCustomTimer(); closeOverlay();" 
                            class="w-full bg-gray-600 text-white py-2 rounded-lg font-medium hover:bg-gray-700">
                            Start Custom Timer
                        </button>
                    </div>
                    
                    <button onclick="closeOverlay()" 
                        class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 mt-3">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function startTimerWithDuration(seconds) {
            state.activeTimer = {
                remaining: seconds,
                total: seconds,
                interval: null
            };

            state.activeTimer.interval = setInterval(() => {
                state.activeTimer.remaining--;
                
                if (state.activeTimer.remaining <= 0) {
                    stopTimer();
                    alert('Rest complete!');
                }
                render();
            }, 1000);

            render();
        }

        function startCustomTimer() {
            const input = document.getElementById('custom-timer');
            const seconds = parseInt(input?.value);
            if (!seconds || seconds <= 0) {
                alert('Please enter a valid number of seconds');
                return;
            }
            startTimerWithDuration(seconds);
        }

        function stopTimer() {
            if (state.activeTimer?.interval) {
                clearInterval(state.activeTimer.interval);
            }
            state.activeTimer = null;
            render();
        }

        function closeOverlay() {
            const overlay = document.querySelector('.fixed.inset-0');
            if (overlay) overlay.remove();
        }

        async function finishWorkout() {
            if (state.currentWorkout.exercises.length === 0 && !state.currentWorkout.isZone5) {
                alert('Add at least one exercise before finishing');
                return;
            }

            state.workouts.push(state.currentWorkout);
            await saveWorkouts();
            
            state.currentWorkout = null;
            stopTimer();
            render();
        }

        function cancelWorkout() {
            if (confirm('Cancel this workout? All progress will be lost.')) {
                state.currentWorkout = null;
                stopTimer();
                render();
            }
        }

        function renderRecentWorkouts() {
            const recent = state.workouts.slice(-5).reverse();
            
            if (recent.length === 0) {
                return `
                    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                        <p>No workouts logged yet</p>
                        <p class="text-sm mt-2">Start your first workout to begin tracking progress</p>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b">
                        <h3 class="font-bold">Recent Workouts</h3>
                    </div>
                    <div class="divide-y">
                        ${recent.map(workout => `
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-bold">${workout.day}</h4>
                                        <p class="text-sm text-gray-500">${new Date(workout.date).toLocaleDateString()} ‚Ä¢ Week ${workout.week}</p>
                                    </div>
                                    ${workout.isZone5 ? 
                                        '<span class="text-sm text-orange-600 font-medium">Zone 5 ‚úì</span>' :
                                        `<span class="text-sm text-gray-500">${workout.exercises.length} exercises</span>`
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showWorkoutHistory() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto';
            
            const workoutsByType = {};
            state.workouts.forEach(workout => {
                if (!workoutsByType[workout.day]) {
                    workoutsByType[workout.day] = [];
                }
                workoutsByType[workout.day].push(workout);
            });
            
            Object.keys(workoutsByType).forEach(day => {
                workoutsByType[day].sort((a, b) => new Date(b.date) - new Date(a.date));
            });
            
            overlay.innerHTML = `
                <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto my-8">
                    <div class="sticky top-0 bg-white border-b p-6 z-10">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Workout History</h2>
                            <button onclick="closeOverlay()" class="text-gray-500 hover:text-gray-700">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        ${Object.entries(workoutsByType).length === 0 ? `
                            <div class="text-center text-gray-500 py-8">
                                <p class="text-lg">No workouts logged yet</p>
                            </div>
                        ` : `
                            ${Object.entries(workoutsByType).map(([day, workouts]) => `
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                                        ${day}
                                        <span class="text-sm font-normal text-gray-500">(${workouts.length} sessions)</span>
                                    </h3>
                                    <div class="space-y-3">
                                        ${workouts.slice(0, 10).map(workout => `
                                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div>
                                                        <div class="font-semibold">${new Date(workout.date).toLocaleDateString()}</div>
                                                        <div class="text-sm text-gray-600">Week ${workout.week}${workout.isZone5 ? ' ‚Ä¢ Zone 5 Cardio' : ` ‚Ä¢ ${workout.exercises.length} exercises`}</div>
                                                    </div>
                                                </div>
                                                
                                                ${workout.isZone5 ? '' : `
                                                    <div class="space-y-2">
                                                        ${workout.exercises.map(ex => `
                                                            <div class="text-sm">
                                                                <div class="font-medium text-gray-900">${ex.name}</div>
                                                                <div class="text-xs text-gray-600">
                                                                    ${ex.sets.filter(s => s.weight && s.reps).map(s => 
                                                                        `${s.weight} lbs √ó ${s.reps}`
                                                                    ).join(', ')}
                                                                </div>
                                                                ${ex.notes ? `
                                                                    <div class="text-xs text-emerald-600 italic mt-1">üìù ${ex.notes}</div>
                                                                ` : ''}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                `}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            overlay.onclick = (e) => {
                if (e.target === overlay) closeOverlay();
            };
        }

        function renderDashboardView() {
            const totalWorkouts = state.workouts.length;
            const thisWeekDates = getWeekDates();
            const thisWeekWorkouts = state.workouts.filter(w => thisWeekDates.includes(new Date(w.date).toDateString())).length;
            
            const weekStreak = calculateWeekStreak();
            const prs = calculatePRs();

            return `
                <div class="p-4">
                    <h2 class="text-2xl font-bold mb-4">Stats</h2>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-lg p-4 shadow">
                            <div class="text-3xl font-bold">${thisWeekWorkouts}</div>
                            <div class="text-sm text-emerald-100">This Week</div>
                        </div>
                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 text-white rounded-lg p-4 shadow">
                            <div class="text-3xl font-bold">${totalWorkouts}</div>
                            <div class="text-sm text-teal-100">Total Workouts</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-lg p-4 shadow">
                            <div class="text-3xl font-bold">${weekStreak}</div>
                            <div class="text-sm text-orange-100">Week Streak üî•</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4 shadow">
                            <div class="text-3xl font-bold">${prs.length}</div>
                            <div class="text-sm text-purple-100">PRs Set</div>
                        </div>
                    </div>

                    ${prs.length > 0 ? `
                        <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 text-gray-900 rounded-lg shadow p-6 mb-4">
                            <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                                üèÜ Personal Records
                            </h3>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                ${prs.slice(0, 8).map(pr => `
                                    <div class="bg-white/50 rounded p-2 flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold text-sm">${pr.exercise}</div>
                                            <div class="text-xs text-gray-700">${new Date(pr.date).toLocaleDateString()}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg">${pr.weight} lbs</div>
                                            <div class="text-xs">${pr.reps} reps</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${renderExerciseProgress()}
                </div>
            `;
        }

        function calculateWeekStreak() {
            if (state.workouts.length === 0) return 0;
            
            let streak = 0;
            let currentDate = new Date();
            
            currentDate.setDate(currentDate.getDate() - currentDate.getDay() + 1);
            currentDate.setHours(0, 0, 0, 0);
            
            while (true) {
                const weekStart = new Date(currentDate);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                
                const workoutsThisWeek = state.workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= weekStart && workoutDate <= weekEnd;
                }).length;
                
                if (workoutsThisWeek >= 4) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 7);
                } else {
                    break;
                }
                
                if (streak > 52) break;
            }
            
            return streak;
        }

        function calculatePRs() {
            const prs = [];
            const exerciseMaxes = {};
            
            const sortedWorkouts = [...state.workouts].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            sortedWorkouts.forEach(workout => {
                if (workout.exercises) {
                    workout.exercises.forEach(exercise => {
                        exercise.sets.forEach(set => {
                            const weight = parseFloat(set.weight);
                            const reps = parseFloat(set.reps);
                            
                            if (weight && reps) {
                                if (!exerciseMaxes[exercise.name]) {
                                    exerciseMaxes[exercise.name] = { weight, reps, date: workout.date };
                                    prs.push({
                                        exercise: exercise.name,
                                        weight,
                                        reps,
                                        date: workout.date
                                    });
                                } else if (weight > exerciseMaxes[exercise.name].weight) {
                                    exerciseMaxes[exercise.name] = { weight, reps, date: workout.date };
                                    prs.push({
                                        exercise: exercise.name,
                                        weight,
                                        reps,
                                        date: workout.date
                                    });
                                }
                            }
                        });
                    });
                }
            });
            
            return prs.reverse();
        }

        function renderExerciseProgress() {
            if (state.workouts.length === 0) {
                return `
                    <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                        <p>Complete workouts to see progress</p>
                    </div>
                `;
            }

            const byExercise = {};
            state.workouts.forEach(workout => {
                if (workout.exercises) {
                    workout.exercises.forEach(exercise => {
                        if (!byExercise[exercise.name]) {
                            byExercise[exercise.name] = [];
                        }
                        byExercise[exercise.name].push({
                            date: workout.date,
                            week: workout.week,
                            sets: exercise.sets
                        });
                    });
                }
            });

            return `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b">
                        <h3 class="font-bold text-lg">Exercise Progress</h3>
                    </div>
                    <div class="divide-y max-h-96 overflow-y-auto">
                        ${Object.entries(byExercise).map(([name, sessions]) => {
                            const latest = sessions[sessions.length - 1];
                            const maxWeight = Math.max(...latest.sets.map(s => parseFloat(s.weight) || 0));
                            const totalVolume = latest.sets.reduce((sum, s) => 
                                sum + ((parseFloat(s.weight) || 0) * (parseFloat(s.reps) || 0)), 0
                            );
                            
                            return `
                                <div class="p-4">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-bold text-sm">${name}</h4>
                                            <p class="text-xs text-gray-500">${sessions.length} sessions</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-emerald-600">${maxWeight} lbs</div>
                                            <div class="text-xs text-gray-500">${Math.round(totalVolume)} vol</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function switchView(view) {
            state.currentView = view;
            render();
        }

        init();
    </script>
</body>
</html>